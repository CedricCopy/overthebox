name: OTB_Build
description: Build for OTB
version: v2.0
workflow:
  overthebox-build:
    pipeline: overthebox-build
    application: overthebox_dev_ccopy
    payload:
      git.author: ""
      git.branch: master
      git.hash: ""
      git.hash.before: ""
      git.message: ""
      git.repository: CedricCopy/overthebox
      git.tag: ""
  sign_package:
    depends_on:
    - overthebox-build
    when:
    - success
    pipeline: sign_package
    environment: signing_prod
metadata:
  default_tags: git.branch,git.author
permissions:
  compute.gra1: 5
  OTB: 7
notifications:
- type: vcs
  pipelines:
  - sign_package
  - overthebox-build
  settings:
    on_success: always
    template:
      body: |
        [[- if .Stages ]]
        CDS Report [[.WorkflowNodeName]]#[[.Number]].[[.SubNumber]] [[ if eq .Status "Success" -]] ✔ [[ else ]][[ if eq .Status "Fail" -]] ✘ [[ else ]][[ if eq .Status "Stopped" -]] ■ [[ else ]]- [[ end ]] [[ end ]] [[ end ]]
        [[- range $s := .Stages]]
        [[- if $s.RunJobs ]]
        * [[$s.Name]]
        [[- range $j := $s.RunJobs]]
          * [[$j.Job.Action.Name]] [[ if eq $j.Status "Success" -]] ✔ [[ else ]][[ if eq $j.Status "Fail" -]] ✘ [[ else ]][[ if eq $j.Status "Stopped" -]] ■ [[ else ]]- [[ end ]] [[ end ]] [[ end ]]
        [[- end]]
        [[- end]]
        [[- end]]
        [[- end]]

        [[- if .Tests ]]
        [[- if gt .Tests.TotalKO 0]]
        Unit Tests Report

        [[- range $ts := .Tests.TestSuites]]
        * [[ $ts.Name ]]
        [[range $tc := $ts.TestCases]]
          [[- if or ($tc.Errors) ($tc.Failures) ]]  * [[ $tc.Name ]] ✘ [[- end]]
        [[end]]
        [[- end]]
        [[- end]]
        [[- end]]
        [[- if {{.workflow.overthebox-build.logcontent }} ]] 
            Logs from the build 
            ``` 
            {{.workflow.overthebox-build.logcontent | b64dec}} 
            ``` 
        [[- end]] 
        Testing comment

      disable_comment: false
      disable_status: false
